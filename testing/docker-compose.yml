version: '3.8'

services:
  # Ansible control node
  ansible-control:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: dotfiles-ansible-control
    volumes:
      - ./playbooks:/ansible/playbooks:ro
      - ./inventories:/ansible/inventories:ro
      - ./vars:/ansible/vars:ro
      - ./templates:/ansible/templates:ro
      - ../:/dotfiles:ro  # Mount dotfiles repo
      - ./logs:/ansible/logs
    networks:
      - dotfiles-test
    depends_on:
      - target-arch

  # Arch Linux test target
  target-arch:
    image: archlinux:latest
    container_name: dotfiles-target-arch
    hostname: arch-test
    networks:
      dotfiles-test:
        ipv4_address: 172.29.0.10
    command: >
      bash -c "
        pacman -Sy --noconfirm openssh sudo python curl git base-devel &&
        useradd -m -s /bin/bash -G wheel testuser &&
        echo 'testuser:testpass' | chpasswd &&
        echo '%wheel ALL=(ALL) NOPASSWD:ALL' >> /etc/sudoers &&
        mkdir -p /home/testuser/.ssh &&
        chmod 700 /home/testuser/.ssh &&
        echo 'ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQC+testkey+' > /home/testuser/.ssh/authorized_keys &&
        chmod 600 /home/testuser/.ssh/authorized_keys &&
        chown -R testuser:testuser /home/testuser/.ssh &&
        ssh-keygen -A &&
        /usr/sbin/sshd -D
      "
    expose:
      - "22"
    ports:
      - "2222:22"

  # Ubuntu 24.04 test target
  target-ubuntu-24:
    build:
      context: ..
      dockerfile: testing/Dockerfile.ubuntu
      args:
        UBUNTU_VERSION: "24.04"
    image: dotfiles-test:ubuntu-24.04
    container_name: dotfiles-target-ubuntu-24
    hostname: ubuntu-24-test
    volumes:
      - ..:/home/testuser/.local/share/chezmoi:ro
    networks:
      dotfiles-test:
        ipv4_address: 172.29.0.11
    stdin_open: true
    tty: true

  # Ubuntu 22.04 test target
  target-ubuntu-22:
    build:
      context: ..
      dockerfile: testing/Dockerfile.ubuntu
      args:
        UBUNTU_VERSION: "22.04"
    image: dotfiles-test:ubuntu-22.04
    container_name: dotfiles-target-ubuntu-22
    hostname: ubuntu-22-test
    volumes:
      - ..:/home/testuser/.local/share/chezmoi:ro
    networks:
      dotfiles-test:
        ipv4_address: 172.29.0.12
    stdin_open: true
    tty: true

  # Debian 12 test target
  target-debian-12:
    build:
      context: ..
      dockerfile: testing/Dockerfile.debian
      args:
        DEBIAN_VERSION: "12"
    image: dotfiles-test:debian-12
    container_name: dotfiles-target-debian-12
    hostname: debian-12-test
    volumes:
      - ..:/home/testuser/.local/share/chezmoi:ro
    networks:
      dotfiles-test:
        ipv4_address: 172.29.0.13
    stdin_open: true
    tty: true

  # Debian 11 test target
  target-debian-11:
    build:
      context: ..
      dockerfile: testing/Dockerfile.debian
      args:
        DEBIAN_VERSION: "11"
    image: dotfiles-test:debian-11
    container_name: dotfiles-target-debian-11
    hostname: debian-11-test
    volumes:
      - ..:/home/testuser/.local/share/chezmoi:ro
    networks:
      dotfiles-test:
        ipv4_address: 172.29.0.14
    stdin_open: true
    tty: true

networks:
  dotfiles-test:
    driver: bridge
    ipam:
      config:
        - subnet: 172.29.0.0/16
