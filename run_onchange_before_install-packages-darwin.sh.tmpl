#!/bin/bash

set -eufo pipefail

echo "Installing Homebrew packages and applications..."

# Check if Homebrew is installed
if ! command -v brew &> /dev/null; then
    echo "Homebrew not found. Installing Homebrew..."
    /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
fi

# Run brew bundle with inline Brewfile
brew bundle --file=/dev/stdin <<EOF

# Taps
tap "withgraphite/tap"

# CLI Tools - Version Control
brew "git"
brew "gh"              # GitHub CLI
brew "git-lfs"         # Git Large File Storage
brew "git-delta"       # Better git diff
brew "git-extras"      # Advanced git commands
brew "git-filter-repo" # Fast git history rewriting
brew "git-crypt"       # Transparent file encryption in git
brew "graphite"        # Modern Git workflow CLI

# CLI Tools - Shell & Terminal
brew "zsh"
brew "bash"
brew "fish"            # Friendly interactive shell
brew "tmux"
brew "zellij"          # Modern terminal multiplexer
brew "starship"        # Modern shell prompt
brew "atuin"           # Shell history with sync

# CLI Tools - Development
brew "asdf"            # Version manager for multiple languages
brew "neovim"
brew "vim"
brew "helix"           # Modern modal editor
brew "node"
brew "deno"            # Modern JavaScript/TypeScript runtime
brew "python@3.12"
brew "go"
brew "rust"
brew "ruby"            # Ruby programming language
brew "php"             # PHP programming language
brew "composer"        # PHP dependency manager
brew "elixir"          # Elixir functional programming language
brew "lua"             # Lua scripting language
brew "openjdk"         # Java Development Kit
brew "jq"              # JSON processor
brew "yq"              # YAML processor
brew "tree"            # Directory tree viewer
brew "ripgrep"         # Fast grep alternative
brew "fd"              # Fast find alternative
brew "bat"             # Better cat with syntax highlighting
brew "eza"             # Modern ls replacement
brew "fzf"             # Fuzzy finder
brew "tldr"            # Simplified man pages
brew "direnv"          # Directory-specific environment variables
brew "zoxide"          # Smarter cd command
brew "watchman"        # File watching service
brew "universal-ctags" # Universal ctags for code navigation
brew "the_silver_searcher" # Fast code search tool
brew "graphviz"        # Graph visualization software

# CLI Tools - DevOps & Cloud
brew "docker"
brew "colima"          # Container runtime for macOS
brew "podman"          # Alternative container runtime
brew "podman-compose"  # Docker compose for Podman
brew "kubectl"
brew "helm"            # Kubernetes package manager
brew "argocd"          # GitOps continuous delivery for Kubernetes
brew "terraform"
brew "ansible"
brew "awscli"
brew "aws-sam-cli"     # AWS Serverless Application Model CLI
brew "azure-cli"
brew "azcopy"          # Azure Storage data transfer utility
brew "azd"             # Azure Developer CLI
brew "kubelogin"       # Kubernetes credential plugin for Azure AD
brew "doctl"           # DigitalOcean CLI
brew "temporal"        # Workflow orchestration
brew "tcld"            # Temporal Cloud CLI
brew "crane"           # Container registry interaction tool
brew "skopeo"          # Work with container images and registries
brew "buildkit"        # Modern Docker build engine
brew "rover"           # GraphQL CLI for Apollo Federation

# CLI Tools - Utilities
brew "wget"
brew "curl"
brew "htop"
brew "btop"            # Resource monitor (better than htop)
brew "ncdu"            # Disk usage analyzer
brew "watch"
brew "gnupg"
brew "openssh"
brew "chezmoi"         # Dotfile manager
brew "httpie"          # Modern HTTP client
brew "posting"         # Modern HTTP client TUI
brew "glow"            # Markdown renderer
brew "slides"          # Terminal-based presentation tool
brew "presenterm"      # Terminal-based presentation tool
brew "mosh"            # Mobile shell
brew "parallel"        # Execute jobs in parallel
brew "shellcheck"      # Shell script linter
brew "bats-core"       # Bash Automated Testing System
brew "vale"            # Prose linter
brew "cloc"            # Count lines of code
brew "speedtest-cli"   # Internet speed test
brew "gping"           # Ping with a graph
brew "iftop"           # Network bandwidth monitoring
brew "asciinema"       # Terminal session recorder
brew "redis"           # In-memory database
brew "uv"              # Fast Python package manager
brew "sentry-cli"      # Sentry command-line client
brew "task"            # Task management
brew "timewarrior"     # Time tracking
brew "terminal-notifier" # Send macOS notifications from CLI
brew "blueutil"        # Bluetooth CLI utility for macOS
brew "jwt-cli"         # JSON Web Token CLI tool
brew "ascii-image-converter" # Convert images to ASCII art
brew "yt-dlp"          # Feature-rich YouTube downloader
brew "yamllint"        # YAML linter
brew "lynx"            # Text-based web browser
brew "telnet"          # Telnet client for debugging
brew "zx"              # Shell scripting with JavaScript
brew "qodana"          # JetBrains code quality platform CLI

{{ if .machine.hasGui }}
# GUI Applications - Development
cask "iterm2"
cask "postman"
cask "tableplus"       # Database GUI

# GUI Applications - Browsers
cask "google-chrome"
cask "firefox"

# GUI Applications - Communication
cask "slack"
cask "discord"

# GUI Applications - Productivity
cask "notion"
cask "obsidian"
cask "rectangle"       # Window manager
cask "raycast"         # Spotlight alternative
cask "caffeine"        # Keep Mac awake

# GUI Applications - Utilities
cask "the-unarchiver"
cask "appcleaner"
cask "keepingyouawake"
cask "stats"           # System monitor in menu bar
{{ end }}

# Fonts
cask "font-fira-code-nerd-font"
cask "font-jetbrains-mono-nerd-font"
cask "font-hack-nerd-font"

# Mac App Store apps (requires mas)
brew "mas"
# mas "Xcode", id: 497799835
# mas "1Password", id: 1333542190

EOF

echo "Homebrew packages and applications installed successfully!"

# Install nvm (Node Version Manager)
if [ ! -d "$HOME/.nvm" ]; then
    echo "Installing nvm..."
    curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.40.1/install.sh | bash
    export NVM_DIR="$HOME/.nvm"
    [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
    echo "nvm installed successfully!"
else
    echo "nvm already installed, skipping..."
fi

# Install global npm packages
if command -v npm &> /dev/null; then
    echo "Installing global npm packages..."

    npm install -g \
        @anthropic-ai/claude-code \
        @openai/codex \
        @devcontainers/cli \
        @mermaid-js/mermaid-cli \
        @usebruno/cli \
        @northflank/cli \
        aws-cdk \
        concurrently \
        dotenv-cli \
        esbuild \
        fast-cli \
        graphql-cli \
        jest \
        neonctl \
        nx \
        terminalizer \
        ts-node \
        tsx \
        typescript \
        webpack-cli

    echo "Global npm packages installed successfully!"
else
    echo "npm not found. Skipping npm package installation."
fi
