---
- name: Test Dotfiles Deployment
  hosts: all
  gather_facts: yes

  vars_files:
    - ../vars/test-config.yml

  pre_tasks:
    - name: Display target information
      ansible.builtin.debug:
        msg: |
          Testing on: {{ inventory_hostname }}
          OS: {{ ansible_distribution }} {{ ansible_distribution_version }}
          Architecture: {{ ansible_architecture }}

    - name: Update package cache (Debian/Ubuntu)
      ansible.builtin.apt:
        update_cache: yes
        cache_valid_time: 3600
      when: ansible_os_family == "Debian"
      become: yes

    - name: Update package cache (Arch)
      community.general.pacman:
        update_cache: yes
      when: ansible_os_family == "Archlinux"
      become: yes

    - name: Update Homebrew (macOS)
      community.general.homebrew:
        update_homebrew: yes
      when: ansible_os_family == "Darwin"

  tasks:
    - name: Install prerequisites
      block:
        - name: Install base packages (Debian/Ubuntu)
          ansible.builtin.apt:
            name:
              - curl
              - git
              - wget
              - build-essential
              - python3-pip
            state: present
          when: ansible_os_family == "Debian"
          become: yes

        - name: Install base packages (Arch)
          community.general.pacman:
            name:
              - curl
              - git
              - wget
              - base-devel
              - python-pip
            state: present
          when: ansible_os_family == "Archlinux"
          become: yes

        - name: Install base packages (macOS)
          community.general.homebrew:
            name:
              - curl
              - git
              - wget
            state: present
          when: ansible_os_family == "Darwin"

    - name: Install chezmoi
      ansible.builtin.shell: |
        sh -c "$(curl -fsLS get.chezmoi.io)" -- -b /usr/local/bin
      args:
        creates: /usr/local/bin/chezmoi
      become: yes

    - name: Verify chezmoi installation
      ansible.builtin.command: /usr/local/bin/chezmoi --version
      register: chezmoi_version
      changed_when: false

    - name: Display chezmoi version
      ansible.builtin.debug:
        var: chezmoi_version.stdout

    - name: Set test user
      ansible.builtin.set_fact:
        test_user: "{{ 'testuser' if ansible_os_family != 'Darwin' else ansible_user }}"
        test_home: "{{ '/home/testuser' if ansible_os_family != 'Darwin' else '/Users/' + ansible_user }}"

    - name: Clone dotfiles repository
      ansible.builtin.git:
        repo: "{{ dotfiles_git_repo }}"
        dest: /tmp/dotfiles-test
        version: "{{ dotfiles_git_branch }}"
        force: yes
      become: yes
      when: dotfiles_git_repo is defined and dotfiles_git_repo != ""

    - name: Initialize chezmoi with test configuration
      ansible.builtin.shell: |
        /usr/local/bin/chezmoi init --source /tmp/dotfiles-test --promptDefaults
      args:
        creates: "{{ test_home }}/.local/share/chezmoi"
      become: "{{ ansible_os_family != 'Darwin' }}"
      become_user: "{{ test_user if ansible_os_family != 'Darwin' else omit }}"
      environment:
        HOME: "{{ test_home }}"

    - name: Test chezmoi in dry-run mode
      ansible.builtin.command: /usr/local/bin/chezmoi apply --dry-run --verbose
      register: chezmoi_dryrun
      changed_when: false
      become: "{{ ansible_os_family != 'Darwin' }}"
      become_user: "{{ test_user if ansible_os_family != 'Darwin' else omit }}"
      environment:
        HOME: "{{ test_home }}"
      failed_when: false

    - name: Display dry-run results
      ansible.builtin.debug:
        var: chezmoi_dryrun.stdout_lines

    - name: Check for package installation script
      ansible.builtin.stat:
        path: "{{ test_home }}/.local/share/chezmoi/run_onchange_before_install-packages-{{ 'linux' if ansible_os_family != 'Darwin' else 'darwin' }}.sh.tmpl"
      register: package_install_script
      become: "{{ ansible_os_family != 'Darwin' }}"
      become_user: "{{ test_user if ansible_os_family != 'Darwin' else omit }}"

    - name: Verify package installation script exists
      ansible.builtin.assert:
        that:
          - package_install_script.stat.exists
        fail_msg: "Package installation script not found for {{ ansible_os_family }}"
        success_msg: "Package installation script found for {{ ansible_os_family }}"

  post_tasks:
    - name: Generate test report
      ansible.builtin.template:
        src: ../templates/test-report.j2
        dest: /tmp/dotfiles-test-report-{{ inventory_hostname }}.txt
        mode: '0644'
      delegate_to: localhost

    - name: Display test summary
      ansible.builtin.debug:
        msg: |
          ========================================
          Test Summary for {{ inventory_hostname }}
          ========================================
          OS: {{ ansible_distribution }} {{ ansible_distribution_version }}
          Chezmoi Version: {{ chezmoi_version.stdout }}
          Test Status: {{ 'PASSED' if chezmoi_dryrun.rc == 0 else 'FAILED' }}
          ========================================
